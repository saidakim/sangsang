<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visual Novel Ultimate - Multi-Character Edition (with Audio)</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;700&display=swap');
        
        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            background-color: #000;
            font-family: 'Noto Sans KR', sans-serif;
            overflow: hidden;
        }

        .game-wrapper {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100vw;
            height: 100vh;
        }

        .game-container {
            position: relative;
            width: 100%;
            height: 100%;
            max-width: 1280px;
            max-aspect-ratio: 16/9;
            background: #111;
            box-shadow: 0 0 50px rgba(0,0,0,0.8);
            overflow: hidden;
        }

        /* ë ˆì´ì–´ ë ˆì´ì•„ì›ƒ */
        #bg-layer { position: absolute; inset: 0; background-size: cover; background-position: center; transition: background-image 1s ease-in-out; z-index: 10; background-color: #111; }
        #cg-layer { position: absolute; inset: 0; z-index: 30; background-size: cover; background-position: center; opacity: 0; transition: opacity 0.8s ease; pointer-events: none; background-color: rgba(0,0,0,0.5); }
        #cg-layer.active { opacity: 1; pointer-events: auto; }
        
        /* ìºë¦­í„° ë ˆì´ì–´ (ë©€í‹° ìºë¦­í„° ëŒ€ì‘) */
        #character-layer { 
            position: absolute; 
            bottom: 80px; 
            left: 0;
            right: 0;
            height: 85%; 
            z-index: 20; 
            display: flex; 
            justify-content: center;
            align-items: flex-end; 
            pointer-events: none;
            gap: 20px;
            padding: 0 50px;
        }
        
        .char-unit {
            height: 100%;
            transition: all 0.5s ease;
            display: flex;
            align-items: flex-end;
            position: relative;
        }

        .char-img { 
            height: 100%; 
            object-fit: contain; 
            transition: all 0.5s ease; 
            filter: drop-shadow(0 10px 20px rgba(0,0,0,0.5)); 
        }

        /* í¬ì»¤ìŠ¤ íš¨ê³¼: ëŒ€í™” ì¤‘ì´ì§€ ì•Šì€ ìºë¦­í„°ëŠ” ì–´ë‘¡ê²Œ */
        .char-unit.unfocused {
            filter: brightness(0.4) grayscale(0.3);
            transform: scale(0.95);
        }

        /* --- ìºë¦­í„° ì• ë‹ˆë©”ì´ì…˜ íš¨ê³¼ --- */
        .eff-shake { animation: shake 0.4s ease-in-out; }
        .eff-bounce { animation: bounce 0.5s ease-out; }
        .eff-zoom { animation: zoom 0.4s ease-in-out; }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-15px); }
            75% { transform: translateX(15px); }
        }
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-40px); }
        }
        @keyframes zoom {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        /* ëŒ€í™”ì°½ */
        .dialogue-box {
            position: absolute;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            width: 94%;
            max-width: 1100px;
            height: 180px;
            background: rgba(10, 10, 20, 0.9);
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 20px;
            padding: 30px 45px;
            color: #eee;
            cursor: pointer;
            z-index: 100;
            box-shadow: 0 15px 35px rgba(0,0,0,0.7);
        }

        /* ì„ íƒì§€ */
        #choice-container { 
            position: absolute; 
            top: 45%; 
            left: 50%; 
            transform: translate(-50%, -50%); 
            width: 100%; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            z-index: 200; 
        }
        .choice-btn { 
            width: 450px; 
            max-width: 85%;
            padding: 22px; 
            margin: 12px; 
            background: rgba(30, 30, 50, 0.95); 
            border: 1px solid rgba(255, 255, 255, 0.2); 
            color: white; 
            border-radius: 15px; 
            text-align: center; 
            cursor: pointer; 
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); 
            font-size: 1.15rem;
            font-weight: 500;
        }
        .choice-btn:hover { background: #4f46e5; border-color: #818cf8; transform: scale(1.05); }

        /* í•˜ë‹¨ ë©”ë‰´ */
        .bottom-menu {
            position: absolute;
            bottom: 8px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 25px;
            z-index: 150;
        }
        .bottom-menu button {
            font-size: 0.7rem;
            font-weight: 700;
            color: rgba(255, 255, 255, 0.3);
            letter-spacing: 0.15em;
            transition: all 0.3s ease;
            text-transform: uppercase;
        }
        .bottom-menu button:hover { color: #fff; }

        /* ì˜¤ë²„ë ˆì´ */
        .full-overlay {
            position: absolute;
            inset: 0;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            opacity: 0;
            visibility: hidden;
            transition: all 0.5s ease;
        }
        .full-overlay.active { opacity: 1; visibility: visible; }

        .menu-overlay { background: linear-gradient(135deg, #0f172a 0%, #1e1b4b 100%); z-index: 950; }
        .title-logo { font-size: clamp(3rem, 10vw, 5rem); font-weight: 900; color: white; letter-spacing: 0.2em; margin-bottom: 4rem; text-align: center; }

        .slot-item { background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.1); padding: 16px; margin-bottom: 12px; border-radius: 14px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; transition: 0.2s; }
        .slot-item:hover { background: rgba(79, 70, 229, 0.15); border-color: #6366f1; }
    </style>
</head>
<body>
<div id="audio-gate" class="full-overlay bg-black active">
  <h2 class="text-white text-3xl font-bold mb-8">í™˜ì˜í•©ë‹ˆë‹¤</h2>
  <button class="choice-btn" onclick="unlockAudioGate()">
    CLICK TO START
  </button>
</div>
<div class="game-wrapper">
    <div class="game-container" id="game-window">
        <div id="bg-layer"></div>
        <div id="cg-layer"></div>
        
        <!-- ìºë¦­í„° ë°°ì¹˜ ë ˆì´ì–´ -->
        <div id="character-layer"></div>
        
        <div id="choice-container" class="hidden"></div>

        <div id="ui-layer" class="hidden opacity-0 transition-opacity duration-500">
            <div class="dialogue-box" id="db-trigger">
                <div id="speaker-name" class="text-indigo-400 font-bold text-xl mb-3 h-7"></div>
                <div id="dialogue-text" class="text-lg leading-relaxed text-gray-100"></div>
                <div id="click-prompt" class="absolute bottom-6 right-10 text-xs text-indigo-400 animate-pulse hidden">CLICK TO NEXT</div>
            </div>
            
            <div class="bottom-menu">
                <button onclick="Game.openSaveMenu()">SAVE</button>
                <button onclick="Game.openLoadMenu()">LOAD</button>
                <button onclick="Game.togglePause()">MENU</button>
            </div>
        </div>

        <!-- ëª¨ë‹¬ ë° ë©”ë‰´ ìƒëµ (ì´ì „ ë²„ì „ê³¼ ë™ì¼í•˜ê²Œ ìœ ì§€) -->
        <div id="custom-modal" class="full-overlay bg-black/80 backdrop-blur-md">
            <div class="bg-[#111] border border-white/10 p-10 rounded-[30px] w-[500px] max-w-[90%] shadow-2xl">
                <h3 id="modal-title" class="text-2xl font-bold text-white mb-6 text-center"></h3>
                <div id="slot-list" class="mb-8"></div>
                <div class="flex justify-center gap-4" id="modal-buttons"></div>
            </div>
        </div>

        <div id="pause-menu" class="full-overlay bg-black/95">
            <h2 class="text-5xl font-bold text-white mb-16 tracking-widest italic">PAUSED</h2>
            <button class="choice-btn" onclick="Game.togglePause()">ê³„ì†í•˜ê¸°</button>
            <button class="choice-btn" onclick="Game.resetToMenu()">íƒ€ì´í‹€ë¡œ ì´ë™</button>
        </div>

        <div id="ending-layer" class="full-overlay bg-black">
            <h2 id="ending-title" class="text-6xl font-black text-white mb-6"></h2>
            <p id="ending-desc" class="text-gray-400 text-xl mb-16 text-center px-10"></p>
            <button class="choice-btn" onclick="Game.resetToMenu()">ì²˜ìŒìœ¼ë¡œ ëŒì•„ê°€ê¸°</button>
        </div>

        <div id="main-menu" class="full-overlay menu-overlay active">
            <h1 class="title-logo italic">LOVE 0f PI</h1>
            <button class="choice-btn" onclick="Game.handleStartButton()">ì²˜ìŒë¶€í„°</button>
            <button class="choice-btn" onclick="Game.openLoadMenu()">ì´ì–´í•˜ê¸°</button>
        </div>
    </div>
  
</div>

<script>
  
let audioUnlocked = false;

function unlockAudioGate() {
  // 1ï¸âƒ£ Audio unlock
  Game.audioManager.unlocked = true;

  // (Safari ëŒ€ì‘ìš© ë”ë¯¸ ì¬ìƒ)
  const silent = new Audio();
  silent.src = "data:audio/mp3;base64,//uQZAAAAAAAAAAAAAAAAAAAA";
  silent.volume = 0;
  silent.play().catch(()=>{});

  // 2ï¸âƒ£ ë©”ë‰´ BGM ì‹œì‘

  // 3ï¸âƒ£ í™˜ì˜ í™”ë©´ ì œê±°
  document.getElementById("audio-gate").classList.remove("active");

  console.log("ğŸ”“ Audio unlocked by user gesture");
  Game.resetToMenu();

}

// ------------------------- ASSETS (images + audio) -------------------------
const assets = {
 
    images: {
        "sang_normal": "https://raw.githubusercontent.com/saidakim/sangsang/main/sang_normal.png",
        "sang_sad": "https://raw.githubusercontent.com/saidakim/sangsang/main/sang_sad.png",
        "sang_wow": "https://raw.githubusercontent.com/saidakim/sangsang/main/sang_wow.png", 
        "sang_happy": "https://raw.githubusercontent.com/saidakim/sangsang/main/sang_happy.png",
        "sang_angry": "https://raw.githubusercontent.com/saidakim/sangsang/main/sang_angry.png",
        "sang_siluet": "https://raw.githubusercontent.com/saidakim/sangsang/main/sang_siluet.png",
      
      
        "gahi_normal": "https://raw.githubusercontent.com/saidakim/sangsang/main/gahi_normal.png",
        "gahi_sad": "https://raw.githubusercontent.com/saidakim/sangsang/main/gahi_sad.png",
        "gahi_wow": "https://raw.githubusercontent.com/saidakim/sangsang/main/gahi_wow.png", 
        "gahi_happy": "https://raw.githubusercontent.com/saidakim/sangsang/main/gahi_happy.png",
        "gahi_angry": "https://raw.githubusercontent.com/saidakim/sangsang/main/gahi_angry.png",
        "gahi_siluet": "https://raw.githubusercontent.com/saidakim/sangsang/main/gahi_siluet.png",
      
      
        "sang_phone": "https://raw.githubusercontent.com/saidakim/sangsang/main/sang_phone.png",
        "sang_phone_alert": "https://raw.githubusercontent.com/saidakim/sangsang/main/sang_phone_alert.png",
      
      
        "kaist_bg": "https://raw.githubusercontent.com/saidakim/sangsang/main/kaist_bg.png",
        "kaist_night_bg": "https://raw.githubusercontent.com/saidakim/sangsang/main/kaist_night_bg.png",
        "kaist_playground_bg": "https://raw.githubusercontent.com/saidakim/sangsang/main/kaist_playground_bg.png",
        "sang_room_bg": "https://raw.githubusercontent.com/saidakim/sangsang/main/sang_room_bg.png",
    },
    audio: {
        // Put your audio URLs here. Examples are placeholders â€” replace with actual hosted audio files.
        // Background music (looping tracks) 
        "bgm_menu": { url: "https://raw.githubusercontent.com/saidakim/sangsang/main/sanddit2.mp3", loop:true, volume:0.45 },
        "bgm_school": { url: "https://raw.githubusercontent.com/saidakim/sangsang/main/sanddit.mp3", loop:true, volume:0.5 },
        "bgm_off": { url: "data:audio/mp3;base64,//uQZAAAAAAAAAAAAAAAAAAAA", loop:true, volume:0.5 },
        // Sound effects (one-shot)
        "sfx_click": { url: "https://raw.githubusercontent.com/saidakim/sangsang/main/click.mp3", volume: 1.0 },
        "sfx_sang_phone": { url: "https://raw.githubusercontent.com/saidakim/sangsang/main/sang_phone.mp3", volume: 0.9 }
    }
};
// ------------------------- AUDIO MANAGER -------------------------
class AudioManager {
  constructor(assets) {
    this.assets = assets;
    this.bgm = new Audio();   // âœ… ë‹¨ í•˜ë‚˜ë§Œ ìƒì„±
    this.bgm.loop = true;
    this.unlocked = false;
     this.sfxPool = []; 
  }
  
    stopBGM() {
    this.bgm.pause();
    this.bgm.currentTime = 0;
  }

playBGM(name) {
  if (!this.unlocked) return;

  const data = this.assets[name];
  if (!data) return;

  if (this.bgm.src !== data.url) {
    this.bgm.src = data.url;
  }

  this.bgm.volume = data.volume ?? 0.5;
  this.bgm.loop = data.loop ?? true;

  this.bgm.play().catch(()=>{});
}
  playSFX(name) {
  if (!this.unlocked) return;

  const data = this.assets[name];
  if (!data) return;

  const sfx = new Audio(data.url);
  sfx.volume = data.volume ?? 1.0;

  sfx.play().catch(()=>{});

  // ëë‚˜ë©´ ë©”ëª¨ë¦¬ ì •ë¦¬
  sfx.onended = () => {
    this.sfxPool = this.sfxPool.filter(a => a !== sfx);
  };

  this.sfxPool.push(sfx);
}

}



// ------------------------- SCENARIO (unchanged flow; audio fields added where appropriate) -------------------------
const scenario = {
    "start": {
        bg: "kaist_bg",
        speaker: " ",
        text: "ì¹´ì´ìŠ¤íŠ¸ ì…í•™ ì²« í•™ê¸°. ìƒˆë‚´ê¸°ë“¤ì˜ ì„¤ë ˜ê³¼ ê³µëŒ€ì˜ ì¹™ì¹™í•¨ì´ ì–´ìš°ëŸ¬ì ¸ ë¯¸ë¬˜í•œ ë¶„ìœ„ê¸°ê°€ íë¥¸ë‹¤.",
        next: "start2",
      bgm: "bgm_school"
    },
    "start2": {
        bg: "kaist_bg",
        speaker: " ",
        text: "ì§€ì˜¤ë©”íŠ¸ë¦¬ëŒ€ì‰¬ ë™ì•„ë¦¬ 'DASH:ED' ë©´ì ‘ì¥ ì•. ",
        next: "start3"
    },
    "start3": {
        bg: "kaist_bg",
        chars: [
            { name: "ì œìƒí›„", image: "sang_siluet", focus: true, eff: "bounce" }
        ],
        speaker: "???",
        text: "(ëšœë²… ëšœë²…)",
        next: "start4"
    },
    "start4": {
        bg: "kaist_bg",
        chars: [
            { name: "ì œìƒí›„", image: "sang_siluet", focus: true }
        ],
        speaker: "???",
        text: "ë‚´ê°€ ë¬´ë¦¬ìˆ˜ Ï€ë¥¼ 8ì´ˆ ë§Œì— ë§í•  ìˆ˜ ìˆë‹¨ ë§ì´ì§€... ì´ ì •ë„ë©´ ì…ë¶€ëŠ” ê»Œì´ê² ì§€.",
        next: "start5"
    },
    "start5": {
        bg: "kaist_bg",
        chars: [
            { name: "ì œìƒí›„", image: "sang_normal", focus: true, eff: "zoom" }
        ],
        speaker: " ",
        text: "ì´ ì¸ë¬¼ì€ ì œìƒí›„. í˜„ì¬ ë‚˜ì´ 19ì„¸, ì¸ì²œê³¼í•™ê³  ì¡°ê¸°ì¡¸ì—…ìœ¼ë¡œ ì¹´ì´ìŠ¤íŠ¸ì— ê°„ì‹ íˆ 6ì°¨ ì¥ë‚œì „í™”ì¶”í•©ìœ¼ë¡œ í•©ê²©í–ˆë‹¤.",
        next: "start6"
    },
    "start6": {
        bg: "kaist_bg",
        chars: [
            { name: "ì œìƒí›„", image: "sang_sad", focus: true, eff: "shake" }
        ],
        speaker: "ì œìƒí›„",
        text: "ëš ëš ëš ëš ... 2ì§€ë§ì´ì—ˆë˜ CatRage Labë§ˆì € ë–¨ì–´ì§€ë‹¤ë‹ˆ..",
        next: "start7"
    },
    "start7": {
        bg: "kaist_bg",
        chars: [
            { name: "ì œìƒí›„", image: "sang_sad", focus: true, eff: "shake" }
        ],
        speaker: " ",
        text: "ì¹´ì´ìŠ¤íŠ¸ì— ì¡´ì¬í•˜ëŠ” ëª¨ë“  ê²Œì„ ë™ì•„ë¦¬ë¥¼ ë–¨ì–´ì§„ ìƒí›„ëŠ” ìŠ¬í””ì— ì ê²¼ë‹¤.",
        next: "start8"
    },
    "start8": {
        bg: "kaist_bg",
        chars: [
            { name: "ì œìƒí›„", image: "sang_wow", focus: true, eff: "shake" }
        ],
        speaker: " ",
        sfx:"sfx_sang_phone",
        text: "ê·¸ë•Œ",
        next: "start9"
    },
    "start9": {
        bg: "kaist_bg",
        chars: [
            { name: "ìƒ í°", image: "sang_phone", focus: false },
            { name: "ì œìƒí›„", image: "sang_normal", focus: true }
        ],
        speaker: "ì œìƒí›„",
        text: "ë­ì§€",
        next: "start10"
    },
    "start10": {
        bg: "kaist_bg",
        chars: [
            { name: "ìƒ í°", image: "sang_phone_alert", focus: true, eff: "shake" },
            { name: "ì œìƒí›„", image: "sang_normal", focus: false}
        ],
        speaker: "ìƒ í°",
        sfx:"sfx_sang_phone",
        text: "[KAIST ì—°ì• ê¸°íšë‹¨]ì—ì„œ ê¸´ê¸‰ ì•ˆë‚´ ë“œë¦½ë‹ˆë‹¤.",
        next: "start11"
    },
    "start11": {
        bg: "kaist_bg",
        chars: [
            { name: "ì œìƒí›„", image: "sang_phone_alert", focus: true, eff: "shake" },
            { name: "ì œìƒí›„", image: "sang_normal", focus: false}
        ],
        speaker: "ìƒ í°",
        sfx:"sfx_sang_phone",
        text: "ì œìƒí›„ë‹˜, AI ê¸°ë°˜ ì·¨í–¥ ë¶„ì„ ê²°ê³¼ ë‹¹ì‹ ê³¼ì˜ ê¶í•©ë¥  94% ìƒëŒ€ë¥¼ ì°¾ì•˜ìŠµë‹ˆë‹¤.",
        next: "start12" // í˜¹ì€ ë‹¤ìŒ ì¥ë©´ ID
    },
    "start12": {
        bg: "kaist_bg",
        chars: [
            { name: "ì œìƒí›„", image: "sang_phone_alert", focus: false, eff: "shake" },
            { name: "ì œìƒí›„", image: "sang_happy", focus: true}
        ],
        speaker: "ì œìƒí›„",
        text: "ì´ì•¼.... ê·¸ê²ƒì´ ì°¸ë§ì…ë‹ˆê¹Œ? ê³ ê²ƒì´ ì°¸ìœ¼ë¡œ ë†€ëìŠ¨ë‹ˆë‹¤...",
        next: "start13" // í˜¹ì€ ë‹¤ìŒ ì¥ë©´ ID
    },
    "start13": {
        bg: "kaist_bg",
        chars: [
            { name: "ì œìƒí›„", image: "sang_phone_alert", focus: false, eff: "shake" },
            { name: "ì œìƒí›„", image: "sang_normal", focus: true}
        ],
        speaker: "ì œìƒí›„",
        text: "ì´ê±°ì´ ê·¸ ë³´ì´ìŠ¤ í”¼ì‹± ê°™ì€ ê²ƒìŠ¨ ì•„ë‹ˆê² ì§€ìš”...",
        next: "start14" // í˜¹ì€ ë‹¤ìŒ ì¥ë©´ ID
    },
        "start14": { 
            bg: "kaist_bg",
            chars: [
            { name: "ì œìƒí›„", image: "sang_phone_alert", focus: false, eff: "shake" },
            { name: "ì œìƒí›„", image: "sang_normal", focus: true}
            ],
            text: "ì–´ë–»ê²Œ ëŒ€ì²˜í• ê¹Œ?",
            choices: [ 
                { text: "ì¹´ì´ìŠ¤íŠ¸ ì—°ì•  ê¸°íšë‹¨? ì§€ë„ë§ˆë¼. ì§‘ê°€ì„œ ëƒ¥ì½”ë‚˜ í•œë‹¤.", next: "start14-1-1", score: 0 },
                { text: "ìš´ë™ì¥ ê°€ì„œ íŒŒì´ë‚˜ ì™¸ìš´ë‹¤.", next: "start14-2-1", score: 0 }
            ]
        },
  
  
  
        "start14-2-1":{
        bg: "kaist_playground_bg",
        chars: [
            { name: "ì œìƒí›„", image: "sang_angry", focus: true, eff:"bounce"}
        ],
        text: "~ì¹´ì´ìŠ¤íŠ¸ ìš´ë™ì¥~",
        next: "start14-2-3"
        },
        "start14-2-3":{
        bg: "kaist_playground_bg",
        chars: [
            { name: "ì œìƒí›„", image: "sang_angry", focus: true, eff:"bounce"}
        ],
        speaker: "ì œìƒí›„",
        text: "ì´ëŸ° ì  ì¥. ì¶•êµ¬ë¶€ê°€ ë‚´ ìš´ë™ì¥ì„ ë‹¤ ì“°ê³ ìˆë‹¤ì•„ì•„ì•…!",
        next: "start14-2-2"
        },
        "start14-2-2":{
        bg: "kaist_playground_bg",
        chars: [
            { name: "ì œìƒí›„", image: "sang_normal", focus: true,eff:"shake"} 
        ],
        speaker: "ì œìƒí›„",
        text: "ì¹˜í‚¨ì´ë‚˜ ë¨¹ìœ¼ëŸ¬ ê°ˆë˜ìš”.",
        next: "chicken"
        },
  
  
        "start14-1-1":{
        bg: "sang_room_bg",
        chars: [
            { name: "ì œìƒí›„", image: "sang_normal", focus: true, eff:""}
        ],
        text: "~ìƒì§‘~",
        next: "start14-1-3"
        },
        "start14-1-3":{
        bg: "sang_room_bg",
        chars: [
            { name: "ì œìƒí›„", image: "sang_normal", focus: true, eff:""}
        ],
        speaker: "ì œìƒí›„",
        text: "ì¹˜í‚¨ì´ë‚˜ ì‹œì¼œ ë¨¹ì„ë˜ìš”.",
        next: "start14-1-2"
        },
        "start14-1-2":{
        bg: "sang_room_bg",
        chars: [
            { name: "ì œìƒí›„", image: "sang_angry", focus: true,eff:"shake"}
        ],
        speaker: "ì œìƒí›„",
        text: "ì•„ì‡. ë°°ë‹¬ì´ ì•ˆë˜ì–ì•„. ë°–ì— ë‚˜ê°€ë©´ ì£½ëŠ” ë³‘ ê±¸ë ¸ëŠ”ë° í¬ì¥í•´ì™€ì•¼ê² ë„¤",
        next: "chicken"
        },
  
  
  
        "chicken" :{
        bg: "kaist_night_bg",
        chars: [
            { name: "ì œìƒí›„", image: "sang_normal", focus: true,eff:"shake"}
        ],
        text: "~ì¹´ì´ìŠ¤íŠ¸ ê·¼ì²˜ í†µë‹­ì§‘~",
        next: "chicken1"
        },
  "chicken1" :{
        bg: "kaist_night_bg",
        chars: [
            { name: "ì œìƒí›„", image: "sang_normal", focus: true,eff:"shake"}
        ],
        text: "(ì™€ì´íŒŒì´ ì•ˆí„°ì§)",
        next: "chicken2"
        },
        "chicken2": {
  bg: "kaist_night_bg",
  chars: [
    { name: "ì œìƒí›„", image: "sang_normal", focus: true }
  ],
  speaker: " ",
  text: "ì¹˜í‚¨ì´ ë‚˜ì˜¤ê¸°ê¹Œì§€ ì•½ 12ë¶„. ì™€ì´íŒŒì´ëŠ” ì—¬ì „íˆ ì¡íˆì§€ ì•ŠëŠ”ë‹¤.",
  next: "chicken3"
},

"chicken3": {
  bg: "kaist_night_bg",
  chars: [
    { name: "ì œìƒí›„", image: "sang_phone", focus: true, eff: "shake" }
  ],
  speaker: " ",
  sfx: "sfx_sang_phone",
  text: "ê·¸ëŠ” í•¸ë“œí°ì„ êº¼ë‚´ ì—°ì• ê¸°íšë‹¨ ë©”ì‹œì§€ë¥¼ ë‹¤ì‹œ í™•ì¸í–ˆë‹¤.",
  next: "chicken4"
},

"chicken4": {
  bg: "kaist_night_bg",
  chars: [
    { name: "ì œìƒí›„", image: "sang_phone_alert", focus: true }
  ],
  speaker: "ìƒ í°",
  text: "ë§¤ì¹­ ëŒ€ìƒ ì •ë³´: ì¥ê°€í¬ / ì „ì‚°ê³¼ 22í•™ë²ˆ\në‹‰ë„¤ì„: GahiFlow\nìµœìƒìœ„ê¶Œ ì½”ë”© ì‹¤ë ¥\nê°œë°œì Â· ê·¸ë¦¼ëŸ¬ Â· ë¹„íŠ¸ì„œë²„ ìœ ì§€ë³´ìˆ˜ì",
  next: "chicken5"
},

"chicken5": {
  bg: "kaist_night_bg",
  chars: [
    { name: "ì œìƒí›„", image: "sang_wow", focus: true, eff: "bounce" }
  ],
  speaker: "ì œìƒí›„",
  text: "ì•„ì•…!!!!!",
  next: "chicken6"
},

"chicken6": {
  bg: "kaist_night_bg",
  chars: [
    { name: "ì œìƒí›„", image: "sang_normal", focus: true }
  ],
  speaker: " ",
  text: "ì¥ì†Œ: ì¹´ì´ìŠ¤íŠ¸ ì •ë¬¸ ì• í†µë‹­ì§‘ 2ì¸µ",
  next: "chicken7"
},

"chicken7": {
  bg: "kaist_night_bg",
  chars: [
    { name: "???", image: "gahi_siluet", focus: false },
    { name: "ì œìƒí›„", image: "sang_normal", focus: true }
  ],
  speaker: "ì œìƒí›„",
  text: "ë­ì•¼ ì—¬ê¸°ì–ì•„?",
  next: "chicken8"
},

"chicken8": {
  bg: "kaist_night_bg",
  chars: [
    { name: "ì¥ê°€í¬", image: "gahi_wow", focus: true },
    { name: "ì œìƒí›„", image: "sang_normal", focus: false }
  ],
  speaker: "ì¥ê°€í¬",
  text: "ì™€... ì§„ì§œ ì‹¤ì¡´í•˜ëŠ” ì‚¬ëŒì´ì—ìš”?",
  next: "chicken9"
},

"chicken9": {
  bg: "kaist_night_bg",
  chars: [
    { name: "ì¥ê°€í¬", image: "gahi_normal", focus: false },
    { name: "ì œìƒí›„", image: "sang_happy", focus: true, eff: "bounce" }
  ],
  speaker: "ì œìƒí›„",
  text: "ë„¤. ì‚¬ëŒ ì•„ë‹ˆë©´ ë­ê² ì–´ìš”. ì‚¬ëŒ ë§ëŠ”ë°ìš”. ë­ìš”. ëƒ¥ì½”í•´ìš”?",
  next: "chicken10"
},

"chicken10": {
  bg: "kaist_night_bg",
  chars: [
    { name: "ì¥ê°€í¬", image: "gahi_wow", focus: true },
    { name: "ì œìƒí›„", image: "sang_normal", focus: false }
  ],
  speaker: " ",
  text: "ê°€í¬ëŠ” ì ì‹œ ë‹¹í™©í–ˆì§€ë§Œ, ì¹¨ì°©í•˜ê²Œ ë‹µë³€í•œë‹¤.",
  next: "chicken11"
},

"chicken11": {
  bg: "kaist_night_bg",
  chars: [
    { name: "ì¥ê°€í¬", image: "gahi_normal", focus: true },
    { name: "ì œìƒí›„", image: "sang_normal", focus: false }
  ],
  speaker: "ì¥ê°€í¬",
  text: "ë„¤?? ëƒ¥.. ë­ìš”? ê³ ì–‘ì´ ë§ì”€í•˜ì‹œëŠ” ê±´ê°€ìš”...\nì§‘ì—ì„œ ê³ ì–‘ì´ë¥¼ í‚¤ìš°ê³  ìˆê³ ìš”.\ní•™êµ ìº í¼ìŠ¤ì—ì„œ êµ¶ê³  ìˆê¸¸ë˜ ë°ë ¤ì™”ì–´ìš”.",
  next: "chicken12"
},

"chicken12": {
  bg: "kaist_night_bg",
  chars: [
    { name: "ì¥ê°€í¬", image: "gahi_wow", focus: false },
    { name: "ì œìƒí›„", image: "sang_angry", focus: true, eff: "shake" }
  ],
  speaker: " ",
  bgm:"bgm_off",
  text: "ì œìƒí›„ëŠ” ë˜¥ ì”¹ì€ í‘œì •ìœ¼ë¡œ ê°œì •ìƒ‰ì„ ë¹¤ë‹¤.",
  next: "chicken13"
},

"chicken13": {
  bg: "kaist_night_bg",
  chars: [
    { name: "ì¥ê°€í¬", image: "gahi_wow", focus: false },
    { name: "ì œìƒí›„", image: "sang_angry", focus: true, eff: "shake" }
  ],
  speaker: "ì œìƒí›„",
  text: "ì•„ë‹ˆìš”. ëƒ¥ì½” ëª°ë¼ìš”? ëƒ¥ì½”ëŒ€ì „ìŸ.\ní•¸ë“œí°ë„ ì—†ì–´?? ì•„ì•„ì•„ì•…!!!!",
  next: "chicken14"
},

"chicken14": {
  bg: "kaist_night_bg",
  chars: [
    { name: "ì¥ê°€í¬", image: "gahi_wow", focus: true },
    { name: "ì œìƒí›„", image: "sang_angry", focus: true, eff: "shake" }
  ],
  speaker: " ",
  text: "ê°€í¬ëŠ” ë‹¹í™©í–ˆì§€ë§Œ, ì´ ìƒí™©ì„ ì¡°ê¸ˆ ì¬ë¯¸ìˆì–´í•˜ëŠ” ë“¯í–ˆë‹¤.\nì£¼ë³€ ì†ë‹˜ë“¤ì´ ì¡°ìš©íˆ ìë¦¬ì—ì„œ ì¼ì–´ë‚˜ê¸° ì‹œì‘í–ˆë‹¤.",
  next: "chicken15"
},

"chicken15": {
  bg: "kaist_night_bg",
  chars: [
    { name: "ì¥ê°€í¬", image: "gahi_normal", focus: true },
    { name: "ì œìƒí›„", image: "sang_normal", focus: false }
  ],
  speaker: "ì¥ê°€í¬",
  bgm: "bgm_school",
  text: "í˜¹ì‹œ... ì·¨ë¯¸ê°€ ë˜ ìˆì–´ìš”?",
  next: "chicken16"
},

"chicken16": {
  bg: "kaist_night_bg",
  chars: [
    { name: "ì¥ê°€í¬", image: "gahi_normal", focus: false },
    { name: "ì œìƒí›„", image: "sang_normal", focus: true, eff: "bounce" }
  ],
  speaker: "ì œìƒí›„",
  text: "ë„¤. Ï€ ì™¸ìš°ë©´ì„œ ìš´ë™ì¥ ëŒê¸°.\nìµœê·¼ì—” ëƒ¥ì½” ë± ì§œë©´ì„œ ë…¸ë˜ë„ ë§Œë“¤ì—ˆì–´ìš”.\në“¤ë ¤ë“œë¦´ê¹Œìš”?",
  next: "chicken17"
},

"chicken17": {
  bg: "kaist_night_bg",
  chars: [
    { name: "ì¥ê°€í¬", image: "gahi_wow", focus: false },
    { name: "ì œìƒí›„", image: "sang_happy", focus: true, eff: "shake" }
  ],
  speaker: "ì œìƒí›„",
  text: "ëš ëš ëš ëš !! ë¹ ë°”ë°¤ í‘¸ì‰¬ì´ì´ìµ!!\nì¥! í’! ì¥! í’!",
  next: "chicken18"
},

"chicken18": {
  bg: "kaist_night_bg",
  chars: [
    { name: "ì¥ê°€í¬", image: "gahi_happy", focus: true, eff: "bounce" },
    { name: "ì œìƒí›„", image: "sang_normal", focus: false, eff: "shake" }
  ],
  speaker: " ",
  text: "ì˜ì™¸ë¡œ, ê°€í¬ëŠ” ì›ƒìŒì„ ì°¸ì§€ ëª»í–ˆë‹¤.",
  next: "chicken19"
},

"chicken19": {
  bg: "kaist_night_bg",
  chars: [
    { name: "ì¥ê°€í¬", image: "gahi_happy", focus: true },
    { name: "ì œìƒí›„", image: "sang_wow", focus: false, eff: "shake" }
  ],
  speaker: "ì¥ê°€í¬",
  text: "ì§„ì§œ ì›ƒê¸´ ì‚¬ëŒì´ë„¤ìš”.\nê´œì°®ì•„ìš”. ì €ë„ ì¤‘ë”© ë• ê¸¸ëƒ¥ì´ì— 70ë§Œì› ë°•ì•˜ì–´ìš”.",
  next: "chicken20"
},

"chicken20": {
  bg: "kaist_night_bg",
  bgm:"bgm_off",
  chars: [
    { name: "ì¥ê°€í¬", image: "gahi_happy", focus: true },
    { name: "ì œìƒí›„", image: "sang_angry", focus: true }
  ],
  speaker: " ",
  text: "ìˆœê°„, ì œìƒí›„ì˜ ëˆˆë¹›ì´ ë³€í–ˆë‹¤.",
  next: "chicken21"
},

"chicken21": {
  bg: "kaist_night_bg",
  chars: [
    { name: "ì¥ê°€í¬", image: "gahi_normal", focus: false },
    { name: "ì œìƒí›„", image: "sang_normal", focus: true }
  ],
  speaker: "ì œìƒí›„",
  text: "...ë¯¸ì¹œì‚¬ëŒì¸ê°€",
  next: "chicken22"
},

"chicken22": {
  bg: "kaist_night_bg",
  chars: [
    { name: "ì¥ê°€í¬", image: "gahi_normal", focus: true },
    { name: "ì œìƒí›„", image: "sang_normal", focus: false }
  ],
  speaker: "ì¥ê°€í¬",
  text: "ë„¤?",
  next: "chicken23"
},

"chicken23": {
  bg: "kaist_night_bg",
  chars: [
    { name: "ì¥ê°€í¬", image: "gahi_siluet", focus: true, eff: "shake" },
    { name: "ì œìƒí›„", image: "sang_normal", focus: true }
  ],
  speaker: " ",
  text: "ê°€í¬ëŠ” ë„ë§ì¹˜ë“¯ í†µë‹­ì§‘ì„ ë‚˜ê°”ë‹¤.",
  next: "chicken24"
},

"chicken24": {
  bg: "kaist_night_bg",
  chars: [
    { name: "ì œìƒí›„", image: "sang_normal", focus: true }
  ],
  speaker: " ",
  text: "ì œìƒí›„ëŠ” ë‹­ë‹¤ë¦¬ë¥¼ ì”¹ìœ¼ë©° ì¤‘ì–¼ê±°ë ¸ë‹¤.",
  next: "chicken25"
},

"chicken25": {
  bg: "kaist_night_bg",
  chars: [
    { name: "ì œìƒí›„", image: "sang_normal", focus: true }
  ],
  speaker: "ì œìƒí›„",
  text: "ì´ê±´... ë””íœìŠ¤ ê²Œì„ì´ ì•„ë‹ˆë¼, ì—°ì•  ì‹œë®¬ë ˆì´ì…˜ì´ì—ˆêµ°.",
  next: "chicken26"
},

"chicken26": {
  bg: "kaist_night_bg",
  chars: [
    { name: "ì œìƒí›„", image: "sang_normal", focus: true }
  ],
  speaker: " ",
  text: "ê·¸ëŠ” ì´ì–´í°ì„ êº¼ë‚´ ë‹¤ì‹œ ë…¸ë˜ë¥¼ í‹€ì—ˆë‹¤.",
  next: "check_ending"
},

  
  
        "path_kind": {
            chars: [
                { name: "ì œìƒí›„", image: "sang_happy", focus: true, eff: "bounce" },
                { name: "ë°•ë¯¸ë‚˜", image: "mina_happy", focus: true, eff: "bounce" }
            ],
            speaker: "ì œìƒí›„",
            text: "í•˜í•˜, ì—­ì‹œ ìš°ë¦¬ ì¹œêµ¬ë¼ë‹ˆê¹Œ! ì¢‹ì•„, ê·¸ëŸ¼ ì…‹ì´ì„œ ì ì‹¬ ë¨¹ìœ¼ëŸ¬ ê°ˆê¹Œ?",
            next: "check_ending"
        },
  
  
  
        "path_curious": {
            chars: [
                { name: "ì œìƒí›„", image: "sang_normal", focus: true, eff: "shake" },
                { name: "ë°•ë¯¸ë‚˜", image: "mina_normal", focus: false }
            ],
            speaker: "ì œìƒí›„",
            text: "ì‘, ì–´ë¦´ ë•Œë¶€í„° ì•Œë˜ ì‚¬ì´ì•¼. ê°‘ì‘ìŠ¤ëŸ¬ì› ë‹¤ë©´ ë¯¸ì•ˆ!",
            next: "check_ending"
        },
        "check_ending": {
            script: (game) => {
                return game.affinity >= 10 ? "ending_happy" : "ending_bad";
            }
        },
        "ending_happy": {
            bg: "kaist_bg",
            isEnding: true,
            title: "FRIENDSHIP END",
            desc: "ë‹¹ì‹ ì€ ìƒí›„, ê·¸ë¦¬ê³  ìƒˆë¡œìš´ ì¹œêµ¬ ë¯¸ë‚˜ì™€ ì¦ê±°ìš´ í•™êµ ìƒí™œì„ ì‹œì‘í•©ë‹ˆë‹¤.",
            text: "í•¨ê»˜ ì›ƒìœ¼ë©° ê±¸ì–´ê°€ëŠ” ë³µë„. ìƒˆë¡œìš´ ì¸ì—°ì€ ì–¸ì œë‚˜ ì„¤ë ˆëŠ” ë²•ì´ë‹¤."
        },
        "ending_bad": {
            bg: "kaist_bg",
            isEnding: true,
            title: "NORMAL END",
            desc: "í‰ë²”í•œ í•˜ë£¨ê°€ ì§€ë‚˜ê°”ìŠµë‹ˆë‹¤.",
            text: "ì§§ì€ ë§Œë‚¨ì´ì—ˆì§€ë§Œ, ì–¸ì  ê°€ ë‹¤ì‹œ ì¹œí•´ì§ˆ ê¸°íšŒê°€ ìˆê² ì§€."
        }
    };


// ------------------------- GAME OBJECT -------------------------
const Game = {
    currentScene: "start",
    isTyping: false,
    typeTimeout: null,
    affinity: 0,
    isPlaying: false, 
    isPaused: false,
    audioManager: new AudioManager(assets.audio),

  
  
  
init() { 
  this.log = [];
  this.choices = [];
  this.queue = [];
  this.overlays = [];
  this.flags = {};
  document.getElementById('db-trigger').onclick = () => this.next();
  window.onkeydown = (e) => {
    if (e.code === "Space" || e.code === "Enter") this.next();
    if (e.code === "Escape" && this.isPlaying) this.togglePause();
  };
},


    startGame() {
        this.isPlaying = true;
        this.isPaused = false;
        document.querySelectorAll('.full-overlay').forEach(el => el.classList.remove('active'));
        document.getElementById('ui-layer').classList.remove('hidden', 'opacity-0');
        this.renderScene();
    },

    renderScene() {
        const data = scenario[this.currentScene];
        if (!data) return;

        if (data.script) {
            this.currentScene = data.script(this);
            this.renderScene();
            return;
        }

        // ë°°ê²½ ë° CG (ê¸°ì¡´ê³¼ ë™ì¼)
        const bgLayer = document.getElementById('bg-layer');
        if (data.bg && assets.images[data.bg]) bgLayer.style.backgroundImage = `url('${assets.images[data.bg]}')`;

        // audio handling: if playing (i.e. not in main menu), play bgm/sfx specified in scene
        if (this.isPlaying) {
            if (data.bgm) {
                this.audioManager.playBGM(data.bgm, { fadeIn: 800 });
            }
            if (data.sfx) this.audioManager.playSFX(data.sfx);
        }

        // [ì—…ë°ì´íŠ¸] ë©€í‹° ìºë¦­í„° ë Œë”ë§
        const charLayer = document.getElementById('character-layer');
        charLayer.innerHTML = ""; // ì´ˆê¸°í™”

        const charList = data.chars || [];
        charList.forEach(char => {
            const charUnit = document.createElement('div');
            charUnit.className = `char-unit ${char.focus === false ? 'unfocused' : ''}`;
            
            const img = document.createElement('img');
            img.src = assets.images[char.image] || '';
            img.className = "char-img";
            
            // ê°œë³„ ì´í™íŠ¸ ì ìš©
            if (char.eff) {
                const effClass = `eff-${char.eff}`;
                img.classList.add(effClass);
                img.onanimationend = () => img.classList.remove(effClass);
            }

            charUnit.appendChild(img);
            charLayer.appendChild(charUnit);
        });

        // ëŒ€ì‚¬ í…ìŠ¤íŠ¸ ë° ì„ íƒì§€ (ê¸°ì¡´ê³¼ ë™ì¼)
        document.getElementById('speaker-name').innerText = data.speaker || "";
        this.typeText(data.text);

        const choiceBox = document.getElementById('choice-container');
        choiceBox.innerHTML = "";
        if (data.choices) {
            choiceBox.classList.remove('hidden');
            data.choices.forEach(c => {
                const b = document.createElement('button');
                b.className = "choice-btn";
                b.innerText = c.text;
                b.onclick = (e) => {
                    e.stopPropagation();
                    // play choice sfx if set
                    if (c.sfx) this.audioManager.playSFX(c.sfx);
                    this.affinity += (c.score || 0);
                    this.currentScene = c.next;
                    choiceBox.classList.add('hidden');
                    this.renderScene();
                };
                choiceBox.appendChild(b);
            });
        } else {
            choiceBox.classList.add('hidden');
        }
    },
  

    typeText(text) {
        this.isTyping = true;
        const target = document.getElementById('dialogue-text');
        const prompt = document.getElementById('click-prompt');
        prompt.classList.add('hidden');
        target.textContent = ""; 
        let i = 0;
        if (this.typeTimeout) clearInterval(this.typeTimeout);
        this.typeTimeout = setInterval(() => {
            target.textContent += text[i++];
            if (i >= text.length) {
                clearInterval(this.typeTimeout);
                this.isTyping = false;
                prompt.classList.remove('hidden');
            }
        }, 35);
    },

    next() {
        if (this.isPaused) return;
        const data = scenario[this.currentScene];
        if (!data || data.choices) return;
        if (this.isTyping) {
            clearInterval(this.typeTimeout);
            document.getElementById('dialogue-text').textContent = data.text;
            this.isTyping = false;
            document.getElementById('click-prompt').classList.remove('hidden');
            return;
        }
        if (data.isEnding) { this.showEnding(data); return; }
        if (data.next) { this.currentScene = data.next; this.renderScene(); }
    },

    // ì„¸ì´ë¸Œ/ë¡œë“œ ê¸°ëŠ¥ ë“±ì€ ì´ì „ ë¡œì§ ìœ ì§€
    showEnding(data) {
        const el = document.getElementById('ending-layer');
        document.getElementById('ending-title').innerText = data.title;
        document.getElementById('ending-desc').innerText = data.desc;
        document.getElementById('ui-layer').classList.add('opacity-0');
        el.classList.add('active');
        // optionally switch bgm for ending
        if (data.bgm) this.audioManager.playBGM(data.bgm, { fadeIn: 600 });
        else this.audioManager.stopBGM({ fadeOut: 600 });
    },

    openSaveMenu() { this.showSlotMenu("ì €ì¥í•  ìŠ¬ë¡¯ì„ ì„ íƒí•˜ì„¸ìš”", (slotIndex) => this.saveToSlot(slotIndex)); },
    openLoadMenu() { this.showSlotMenu("ë¶ˆëŸ¬ì˜¬ ìŠ¬ë¡¯ì„ ì„ íƒí•˜ì„¸ìš”", (slotIndex) => this.loadFromSlot(slotIndex)); },
    showSlotMenu(title, callback) {
        const modal = document.getElementById('custom-modal');
        document.getElementById('modal-title').innerText = title;
        const slotList = document.getElementById('slot-list');
        slotList.innerHTML = "";
        for (let i = 1; i <= 3; i++) {
            const savedData = localStorage.getItem(`vn_ultimate_slot_${i}`);
            const slot = document.createElement('div');
            slot.className = "slot-item";
            if (savedData) {
                const parsed = JSON.parse(savedData);
                slot.innerHTML = `<div><span class="text-indigo-400 font-bold text-xs mr-2">SLOT ${i}</span><span class="text-white text-sm">${parsed.sceneName}</span></div>`;
            } else { slot.innerHTML = `<span class="text-gray-600 font-bold">SLOT ${i} EMPTY</span>`; }
            slot.onclick = () => { modal.classList.remove('active'); callback(i); };
            slotList.appendChild(slot);
        }
        const btnContainer = document.getElementById('modal-buttons');
        btnContainer.innerHTML = `<button class="text-gray-500" onclick="document.getElementById('custom-modal').classList.remove('active')">CANCEL</button>`;
        modal.classList.add('active');
    },
    saveToSlot(slotIndex) {
        const data = scenario[this.currentScene];
        localStorage.setItem(`vn_ultimate_slot_${slotIndex}`, JSON.stringify({
            scene: this.currentScene, affinity: this.affinity, sceneName: (data.text || "ì§„í–‰ ì¤‘").substring(0, 15)
        }));
    }, 
    loadFromSlot(slotIndex) {
      this.audioManager.playSFX("sfx_click");
        const saved = localStorage.getItem(`vn_ultimate_slot_${slotIndex}`);
        if (saved) { const d = JSON.parse(saved); this.currentScene = d.scene; this.affinity = d.affinity; this.startGame(); }
    },
    togglePause() { this.isPaused = !this.isPaused; document.getElementById('pause-menu').classList.toggle('active'); },
resetToMenu() {
  this.isPlaying = false;
  document.querySelectorAll('.full-overlay').forEach(el => el.classList.remove('active'));
  document.getElementById('main-menu').classList.add('active');
  document.getElementById('ui-layer').classList.add('hidden', 'opacity-0');

  this.audioManager.stopBGM();
  this.audioManager.playBGM("bgm_menu");
},

    handleStartButton() { this.audioManager.playSFX("sfx_click");this.currentScene = "start"; this.affinity = 0; this.startGame(); }
};

Game.init();
</script>
</body>
</html> 
